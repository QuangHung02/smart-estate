// ==================================================
// SMART REAL ESTATE MARKETPLACE â€” ERD v2 (CLEAN)
// Monetization: ACTION POINTS
// - Monthly points (expire end-of-month): USER/SELLER +3, BROKER +20 (BE job)
// - Permanent points: purchased via point packages
// - Costs: Post -1, Boost(7 days) -10, Takeover -30, Broker activation -60 (BE logic)
// Payments: ONLY for buying point packages
// Key hardening: point_ledger + month bucket, chat read-state, payment snapshots + idempotency
// ==================================================


// =========================
// ENUMS
// =========================
Enum user_role_enum {
  USER
  SELLER
  BROKER
  ADMIN
}

Enum broker_status_enum {
  ACTIVE
  SUSPENDED
}

Enum moderation_decision_enum {
  AUTO_APPROVE
  AUTO_REJECT
  NEED_REVIEW
}

Enum moderation_status_enum {
  PENDING_REVIEW
  APPROVED
  REJECTED
}

Enum listing_lifecycle_status_enum {
  ACTIVE
  DONE
  CANCELLED
}

Enum transaction_type_enum {
  SALE
  RENT
}

Enum broker_request_status_enum {
  NEW
  ACCEPTED
  REJECTED
}

Enum message_attachment_group_enum {
  NONE
  MEDIA
  FILE
}

Enum attachment_type_enum {
  IMAGE
  VIDEO
  FILE
}

Enum broker_application_status_enum {
  PENDING
  APPROVED
  REJECTED
}

// Point ledger
Enum point_bucket_enum {
  MONTHLY
  PERMANENT
}

Enum point_tx_type_enum {
  GRANT_MONTHLY
  PURCHASE_POINTS
  SPEND_POST
  SPEND_BOOST
  SPEND_TAKEOVER
  SPEND_BROKER_ACTIVATION
  ADJUSTMENT
}

// Payments: ONLY for point packages
Enum payment_status_enum {
  PENDING
  PAID
  FAILED
  REFUNDED
}

Enum payment_fee_type_enum {
  POINT_PACKAGE
}


// =========================
// TABLES
// =========================
Table users {
  id            uuid [pk]
  full_name     varchar(120)
  email         varchar(255) [not null, unique]
  password_hash varchar(255) [not null]

  role          user_role_enum [not null, default: 'USER']

  // Optional: only meaningful when role=BROKER (BE enforces)
  broker_status broker_status_enum

  phone         varchar(30)
  avatar_url    text

  created_at    timestamptz [not null, default: `now()`]
  updated_at    timestamptz [not null, default: `now()`]

  Indexes {
    (email) [unique]
    (role)
    (broker_status)
  }
}


// -------------------------
// POINTS
// -------------------------
Table user_points {
  user_id             uuid [pk] // FK -> users.id

  // "Current month" bucket for monthly points
  monthly_month_key   varchar(7) [not null, default: '1970-01'] // YYYY-MM
  monthly_balance     int  [not null, default: 0]

  // Permanent points never reset
  permanent_balance   int  [not null, default: 0]

  // Guard against double grant in the same month
  last_grant_month_key varchar(7) [not null, default: '1970-01']

  updated_at          timestamptz [not null, default: `now()`]

  Indexes { (user_id) }
}

// Ledger for every +/- points (audit + concurrency-safe)
Table point_ledger {
  id               uuid [pk]
  user_id           uuid [not null]

  bucket            point_bucket_enum [not null]          // MONTHLY or PERMANENT
  month_key         varchar(7)                            // YYYY-MM for MONTHLY tx (nullable for permanent)
  tx_type           point_tx_type_enum [not null]
  delta             int [not null]                        // positive or negative

  source_type       varchar(40)                           // e.g., LISTING, LISTING_BOOST, BROKER_REQUEST, BROKER_APPLICATION, POINT_PURCHASE
  source_id         uuid

  note              text
  created_at        timestamptz [not null, default: `now()`]

  Indexes {
    (user_id)
    (bucket, month_key)
    (tx_type)
    (source_type, source_id)
    (created_at)
  }
}

Table point_packages {
  id            uuid [pk]
  name          varchar(80) [not null]     // "30 Points", "60 Points"
  points_amount int [not null]             // 30 / 60
  price_amount  numeric(14,2) [not null]   // 30000 / 50000
  currency      varchar(10) [not null, default: 'VND']
  is_active     boolean [not null, default: true]

  created_at    timestamptz [not null, default: `now()`]
  updated_at    timestamptz [not null, default: `now()`]

  Indexes {
    (is_active)
    (points_amount)
  }
}

Table point_purchases {
  id               uuid [pk]
  user_id           uuid [not null]
  package_id        uuid [not null]

  // Snapshot at purchase time (audit-safe if package price changes later)
  package_name_snapshot varchar(80) [not null]
  points_granted        int [not null]
  price_amount_snapshot numeric(14,2) [not null]
  currency_snapshot     varchar(10) [not null, default: 'VND']

  created_at        timestamptz [not null, default: `now()`]

  Indexes {
    (user_id)
    (package_id)
    (created_at)
  }
}

// Payments only for point package purchases
Table payments {
  id               uuid [pk]
  payer_user_id    uuid [not null]

  fee_type         payment_fee_type_enum [not null, default: 'POINT_PACKAGE']
  amount           numeric(14,2) [not null]
  currency         varchar(10) [not null, default: 'VND']

  status           payment_status_enum [not null, default: 'PENDING']
  paid_at          timestamptz

  point_purchase_id uuid [not null, unique] // 1 purchase -> 1 payment

  provider         varchar(40)              // "MOMO", "VNPAY", "SANDBOX"
  provider_ref     varchar(120)             // transaction id from provider

  created_at       timestamptz [not null, default: `now()`]
  updated_at       timestamptz [not null, default: `now()`]

  Indexes {
    (payer_user_id)
    (status)
    (paid_at)
    (point_purchase_id) [unique]
    (provider, provider_ref)
  }
}


// -------------------------
// LISTINGS + MODERATION + BOOST
// -------------------------
Table listings {
  id                    uuid [pk]

  title                 varchar(200) [not null]
  description           text
  property_type         varchar(50) [not null]
  transaction_type      transaction_type_enum [not null, default: 'SALE']

  price                 numeric(14,2) [not null]
  area_m2               numeric(10,2)
  bedrooms              int
  bathrooms             int

  address_line          text
  city                  varchar(80) [not null]
  district              varchar(80) [not null]
  ward                  varchar(80)

  latitude              numeric(10,7)
  longitude             numeric(10,7)
  virtual_tour_url      text

  moderation_status     moderation_status_enum [not null, default: 'PENDING_REVIEW']
  lifecycle_status      listing_lifecycle_status_enum [not null, default: 'ACTIVE']

  created_by_user_id    uuid [not null]
  responsible_user_id   uuid [not null]

  created_at            timestamptz [not null, default: `now()`]
  updated_at            timestamptz [not null, default: `now()`]

  Indexes {
    (moderation_status)
    (lifecycle_status)
    (transaction_type)
    (created_by_user_id)
    (responsible_user_id)
    (city, district)
    (price)
  }
}

Table listing_images {
  id         uuid [pk]
  listing_id uuid [not null]
  image_url  text [not null]
  sort_order int  [not null, default: 0]
  created_at timestamptz [not null, default: `now()`]

  Indexes { (listing_id) }
}

// Boost listing: costs -10 points, lasts 7 days (BE sets ends_at)
Table listing_boosts {
  id                uuid [pk]
  listing_id         uuid [not null]
  boosted_by_user_id uuid [not null]

  points_cost        int [not null, default: 10]
  starts_at          timestamptz [not null, default: `now()`]
  ends_at            timestamptz [not null]

  created_at         timestamptz [not null, default: `now()`]

  Indexes {
    (listing_id)
    (boosted_by_user_id)
    (ends_at)
  }
  // Note (migration SQL): you may add partial unique index to prevent overlapping active boosts per listing
  // e.g., UNIQUE(listing_id) WHERE ends_at > now()
}

Table moderation_reports {
  id           uuid [pk]
  listing_id   uuid [not null]

  score        int  [not null, default: 0]
  flags        jsonb
  suggestions  jsonb

  // AI decision (stored)
  decision     moderation_decision_enum [not null, default: 'NEED_REVIEW']

  // Admin review only when decision=NEED_REVIEW
  reviewed_by_admin_id uuid
  reviewed_at          timestamptz
  review_outcome       moderation_status_enum // APPROVED or REJECTED when admin reviews

  created_at   timestamptz [not null, default: `now()`]

  Indexes {
    (listing_id)
    (created_at)
    (decision)
    (reviewed_by_admin_id)
  }
}


// -------------------------
// BROKER ONBOARDING + TAKEOVER
// -------------------------
Table broker_applications {
  id                   uuid [pk]
  user_id              uuid [not null, unique]

  status               broker_application_status_enum [not null, default: 'PENDING']
  doc_url              text
  note                 text

  reviewed_by_admin_id uuid
  reviewed_at          timestamptz

  activation_points_cost int [not null, default: 60]
  is_activation_paid     boolean [not null, default: false]
  activation_paid_at     timestamptz

  created_at           timestamptz [not null, default: `now()`]
  updated_at           timestamptz [not null, default: `now()`]

  Indexes {
    (user_id) [unique]
    (status)
    (reviewed_by_admin_id)
  }
}

Table broker_requests {
  id                    uuid [pk]
  listing_id             uuid [not null]

  seller_id              uuid [not null]
  broker_id              uuid [not null]
  requested_by_user_id   uuid [not null]

  status                 broker_request_status_enum [not null, default: 'NEW']
  note                   text

  takeover_points_cost   int  [not null, default: 30]
  is_fee_paid            boolean [not null, default: false]
  paid_at                timestamptz

  created_at             timestamptz [not null, default: `now()`]
  updated_at             timestamptz [not null, default: `now()`]

  Indexes {
    (listing_id)
    (seller_id)
    (broker_id)
    (requested_by_user_id)
    (status)
    (is_fee_paid)
  }
  // Note (migration SQL): you may add partial unique index to prevent multiple NEW requests per (listing_id, broker_id)
}


// -------------------------
// CHAT
// -------------------------
Table conversations {
  id                         uuid [pk]
  listing_id                  uuid [not null]
  buyer_user_id               uuid [not null]
  current_responsible_user_id uuid [not null]
  last_message_at             timestamptz
  created_at                  timestamptz [not null, default: `now()`]

  Indexes {
    (listing_id)
    (buyer_user_id)
    (current_responsible_user_id)
    (last_message_at)
    (listing_id, buyer_user_id) [unique]
  }
}

// Read state per user per conversation (replaces messages.is_read)
Table conversation_reads {
  conversation_id  uuid [not null]
  user_id          uuid [not null]
  last_read_at     timestamptz

  Indexes {
    (conversation_id, user_id) [unique]
    (user_id)
  }
}

Table messages {
  id               uuid [pk]
  conversation_id  uuid [not null]
  sender_user_id   uuid [not null]

  attachment_group message_attachment_group_enum [not null, default: 'NONE']
  content          text

  created_at       timestamptz [not null, default: `now()`]

  Indexes {
    (conversation_id)
    (sender_user_id)
    (created_at)
  }
}

Table message_attachments {
  id               uuid [pk]
  message_id       uuid [not null]
  attachment_type  attachment_type_enum [not null]

  file_url         text [not null]
  mime_type        varchar(120)
  size_bytes       bigint
  original_name    text

  created_at       timestamptz [not null, default: `now()`]

  Indexes {
    (message_id)
    (attachment_type)
  }
}


// -------------------------
// RECOMMEND + REPORTS
// -------------------------
Table user_preferences {
  id             uuid [pk]
  user_id         uuid [not null, unique] // 1 user = 1 preferences set

  city            varchar(80)
  district        varchar(80)
  property_type   varchar(50)
  budget_min      numeric(14,2)
  budget_max      numeric(14,2)
  min_bedrooms    int
  min_area_m2     numeric(10,2)

  created_at      timestamptz [not null, default: `now()`]
  updated_at      timestamptz [not null, default: `now()`]

  Indexes { (user_id) [unique] }
}

Table listing_reports {
  id               uuid [pk]
  listing_id        uuid [not null]
  reporter_user_id  uuid [not null]
  reason            varchar(80) [not null]
  note              text
  created_at        timestamptz [not null, default: `now()`]

  Indexes {
    (listing_id)
    (reporter_user_id)
    (created_at)
  }
}

Table broker_reviews {
  id               uuid [pk]
  broker_id        uuid [not null]
  reviewer_user_id uuid [not null]
  listing_id       uuid
  rating           int [not null] // 1..5 validated in BE
  note             text
  created_at       timestamptz [not null, default: `now()`]

  Indexes {
    (broker_id)
    (reviewer_user_id)
    (listing_id)
    (created_at)
  }
}


// =========================
// RELATIONSHIPS
// =========================
Ref: user_points.user_id > users.id
Ref: point_ledger.user_id > users.id

Ref: point_purchases.user_id > users.id
Ref: point_purchases.package_id > point_packages.id

Ref: payments.payer_user_id > users.id
Ref: payments.point_purchase_id > point_purchases.id

Ref: listings.created_by_user_id > users.id
Ref: listings.responsible_user_id > users.id
Ref: listing_images.listing_id > listings.id
Ref: listing_boosts.listing_id > listings.id
Ref: listing_boosts.boosted_by_user_id > users.id

Ref: moderation_reports.listing_id > listings.id
Ref: moderation_reports.reviewed_by_admin_id > users.id

Ref: broker_applications.user_id > users.id
Ref: broker_applications.reviewed_by_admin_id > users.id

Ref: broker_requests.listing_id > listings.id
Ref: broker_requests.seller_id > users.id
Ref: broker_requests.broker_id > users.id
Ref: broker_requests.requested_by_user_id > users.id

Ref: conversations.listing_id > listings.id
Ref: conversations.buyer_user_id > users.id
Ref: conversations.current_responsible_user_id > users.id

Ref: conversation_reads.conversation_id > conversations.id
Ref: conversation_reads.user_id > users.id

Ref: messages.conversation_id > conversations.id
Ref: messages.sender_user_id > users.id
Ref: message_attachments.message_id > messages.id

Ref: user_preferences.user_id > users.id

Ref: listing_reports.listing_id > listings.id
Ref: listing_reports.reporter_user_id > users.id

Ref: broker_reviews.broker_id > users.id
Ref: broker_reviews.reviewer_user_id > users.id
Ref: broker_reviews.listing_id > listings.id


// =========================
// TABLE GROUPS (for dbdiagram readability)
// =========================
TableGroup "Core" {
  users
}

TableGroup "Listings" {
  listings
  listing_images
  listing_boosts
  moderation_reports
  listing_reports
}

TableGroup "Broker" {
  broker_applications
  broker_requests
  broker_reviews
}

TableGroup "Chat" {
  conversations
  conversation_reads
  messages
  message_attachments
}

TableGroup "Points" {
  user_points
  point_ledger
  point_packages
  point_purchases
  payments
}

TableGroup "Recommend" {
  user_preferences
}